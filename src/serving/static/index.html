<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Taxi Predictor | MLOps</title>
    <!-- Tailwind CSS (via CDN for simplicity) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Custom aesthetics on top of Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }

        .tab-inactive {
            color: #6b7280;
        }

        .tab-inactive:hover {
            color: #374151;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-taxi text-yellow-500 text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">NYC Taxi Predictor</h1>
                </div>
                <!-- API Status Indicator -->
                <div class="flex items-center">
                    <div id="api-status" class="flex items-center text-sm font-medium text-gray-500">
                        <span class="h-3 w-3 rounded-full bg-gray-300 mr-2"></span> Checking API...
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Tabs -->
        <div class="mb-8 border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('prediction')" id="tab-btn-prediction"
                    class="tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    ðŸš€ Prediction
                </button>
                <button onclick="switchTab('monitoring')" id="tab-btn-monitoring"
                    class="tab-inactive whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm">
                    ðŸ“Š Monitoring & Drift
                </button>
            </nav>
        </div>

        <!-- TAB 1: PREDICTION -->
        <div id="tab-prediction" class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">

            <!-- Input Form -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-lg font-semibold mb-6 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> Trip Details
                </h2>

                <form id="prediction-form" onsubmit="handlePredict(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Distance -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Trip Distance (miles)</label>
                            <input type="number" step="0.1" id="trip_distance" value="2.5"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <!-- Passengers -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Passengers</label>
                            <input type="number" min="1" max="6" id="passenger_count" value="1"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <!-- Vendor -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
                            <select id="VendorID"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                <option value="2">VeriFone Inc.</option>
                                <option value="1">Creative Mobile</option>
                            </select>
                        </div>

                        <!-- Date/Time Simulators (Since API takes raw integers) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hour (0-23)</label>
                            <input type="number" min="0" max="23" id="pickup_hour" value="14"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day of Week</label>
                            <select id="pickup_dayofweek"
                                class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2" selected>Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>

                        <!-- Hidden inputs/constants for simplicity -->
                        <input type="hidden" id="pickup_month" value="1">
                        <input type="hidden" id="PULocationID" value="161">
                        <input type="hidden" id="DOLocationID" value="237">
                    </div>

                    <div class="mt-8">
                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transform transition hover:scale-[1.02] shadow-md">
                            ðŸ”® Predict Fare
                        </button>
                    </div>
                </form>
            </div>

            <!-- Result Panel -->
            <div class="space-y-6">
                <!-- Fare Card -->
                <div id="result-card"
                    class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl shadow-lg p-8 text-white hidden transform transition-all duration-500 ease-out self-start">
                    <div class="text-blue-100 text-sm font-medium uppercase tracking-wide mb-1">Estimated Fare</div>
                    <div class="flex items-baseline">
                        <span class="text-5xl font-bold" id="fare-amount">$0.00</span>
                        <span class="ml-2 text-blue-200">USD</span>
                    </div>
                </div>

                <!-- Recent History -->
                <div class="bg-white rounded-xl shadow p-6 self-start">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wide">Recent Predictions</h3>
                        <button onclick="clearHistory()"
                            class="text-xs text-red-500 hover:text-red-700 font-medium">Clear</button>
                    </div>
                    <div id="history-list" class="space-y-3 max-h-64 overflow-y-auto">
                        <div class="text-gray-400 text-sm text-center py-4">No history yet</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB 2: MONITORING -->
        <div id="tab-monitoring" class="hidden">
            <div class="bg-white rounded-xl shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-900">Drift Detection Dashboard</h2>
                    <button onclick="fetchMonitoringData()"
                        class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh Data
                    </button>
                </div>

                <!-- Drift Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Feature 1 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Distance Drift</div>
                        <div class="flex items-end justify-between">
                            <div class="text-2xl font-bold" id="drift-distance-val">-</div>
                            <div id="drift-distance-status" class="text-sm font-medium">-</div>
                        </div>
                        <div class="h-1 w-full bg-gray-200 mt-3 rounded-full overflow-hidden">
                            <div id="drift-distance-bar" class="h-full bg-blue-500 w-0 transition-all duration-500">
                            </div>
                        </div>
                    </div>

                    <!-- Feature 2: Target Drift -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Target Drift (Fare)</div>
                        <div class="flex items-end justify-between">
                            <div class="text-2xl font-bold" id="drift-target-val">-</div>
                            <div id="drift-target-status" class="text-sm font-medium">-</div>
                        </div>
                        <div class="h-1 w-full bg-gray-200 mt-3 rounded-full overflow-hidden">
                            <div id="drift-target-bar" class="h-full bg-purple-500 w-0 transition-all duration-500">
                            </div>
                        </div>
                    </div>

                    <!-- Feature 3 -->
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-100">
                        <div class="text-xs text-gray-500 uppercase font-semibold mb-1">Overall Status</div>
                        <div class="flex items-center mt-2">
                            <span
                                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span> Healthy
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Model Info Card -->
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-100 mb-8">
                    <h3 class="text-xs text-blue-600 uppercase font-semibold mb-2">ðŸ¤– Active Model</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Name:</span>
                            <span id="model-info-name" class="font-bold text-gray-800 ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Version:</span>
                            <span id="model-info-version" class="font-bold text-gray-800 ml-1">-</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Total Predictions:</span>
                            <span id="model-info-count" class="font-bold text-gray-800 ml-1">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500">Status:</span>
                            <span class="font-bold text-green-600 ml-1">âœ“ Running</span>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">ðŸ“Š Distance Distribution (Histogram)</h3>
                        <canvas id="chart-distance-hist"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">ðŸ“ˆ Avg Comparison (Bar)</h3>
                        <canvas id="chart-distance"></canvas>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">ï¿½ Fare/Target Distribution (Histogram)</h3>
                        <canvas id="chart-target-hist"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-4">ðŸ“ˆ Fare Avg Comparison</h3>
                        <canvas id="chart-target"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- State Management ---
        const API_BASE = window.location.origin; // Adapts to localhost or heroku
        let charts = {};

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            checkHealth();
            loadHistory(); // New: Load from LocalStorage
            // Start polling health
            setInterval(checkHealth, 30000);
        });

        // --- Navigation ---
        function switchTab(tabName) {
            // UI Toggle
            document.querySelectorAll('[id^="tab-btn-"]').forEach(el => {
                el.classList.remove('tab-active', 'border-b-2');
                el.classList.add('tab-inactive', 'border-transparent');
            });
            document.getElementById(`tab-btn-${tabName}`).classList.add('tab-active', 'border-b-2');
            document.getElementById(`tab-btn-${tabName}`).classList.remove('tab-inactive', 'border-transparent');

            // Content Toggle
            document.getElementById('tab-prediction').classList.add('hidden');
            document.getElementById('tab-monitoring').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            if (tabName === 'monitoring') {
                fetchMonitoringData();
            }
        }

        // --- API Interactions ---
        async function checkHealth() {
            const statusEl = document.getElementById('api-status');
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (res.ok) {
                    statusEl.innerHTML = '<span class="h-3 w-3 rounded-full bg-green-500 mr-2"></span> System Online';
                } else {
                    throw new Error('API Error');
                }
            } catch (e) {
                statusEl.innerHTML = '<span class="h-3 w-3 rounded-full bg-red-500 mr-2"></span> System Offline';
            }
        }

        async function handlePredict(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            const payload = {
                trip_distance: parseFloat(document.getElementById('trip_distance').value),
                passenger_count: parseInt(document.getElementById('passenger_count').value),
                pickup_hour: parseInt(document.getElementById('pickup_hour').value),
                pickup_dayofweek: parseInt(document.getElementById('pickup_dayofweek').value),
                PULocationID: parseInt(document.getElementById('PULocationID').value),
                DOLocationID: parseInt(document.getElementById('DOLocationID').value),
                pickup_month: parseInt(document.getElementById('pickup_month').value),
                is_weekend: 0, // Simplified
                trip_duration_minutes: 15.0 // Default
            };

            try {
                const res = await fetch(`${API_BASE}/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error(await res.text());

                const data = await res.json();

                // Show Result
                document.getElementById('fare-amount').innerText = `$${data.predicted_fare.toFixed(2)}`;

                const card = document.getElementById('result-card');
                card.classList.remove('hidden');
                card.classList.add('scale-100'); // Animation trigger if needed

                // Add to detailed history list
                addToHistory(payload, data.predicted_fare);

            } catch (err) {
                alert("Prediction Failed: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function addToHistory(input, fare) {
            const list = document.getElementById('history-list');
            const itemHTML = `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100">
                    <div>
                        <div class="text-sm font-medium text-gray-800">${input.trip_distance} miles â€¢ ${input.passenger_count} pass.</div>
                        <div class="text-xs text-gray-500">Hour: ${input.pickup_hour}:00</div>
                    </div>
                    <div class="font-bold text-green-600">$${fare.toFixed(2)}</div>
                </div>
            `;

            // Remove "No history" text if present
            if (list.querySelector('.text-center')) list.innerHTML = '';

            // Add to UI
            const wrapper = document.createElement('div');
            wrapper.innerHTML = itemHTML;
            list.prepend(wrapper.firstElementChild);

            // Save to LocalStorage
            saveHistoryToStorage(input, fare);
        }

        // --- LocalStorage Logic ---
        function saveHistoryToStorage(input, fare) {
            let history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
            history.unshift({ input, fare, timestamp: new Date().toISOString() });
            if (history.length > 10) history.pop(); // Keep last 10
            localStorage.setItem('taxi_history', JSON.stringify(history));
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('taxi_history') || '[]');
            const list = document.getElementById('history-list');

            if (history.length === 0) return; // Keep default empty msg

            list.innerHTML = ''; // Clear default msg
            history.forEach(item => {
                const itemHTML = `
                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 mb-2">
                        <div>
                            <div class="text-sm font-medium text-gray-800">${item.input.trip_distance} miles â€¢ ${item.input.passenger_count} pass.</div>
                            <div class="text-xs text-gray-500">Hour: ${item.input.pickup_hour}:00</div>
                        </div>
                        <div class="font-bold text-green-600">$${item.fare.toFixed(2)}</div>
                    </div>
                `;
                list.innerHTML += itemHTML;
            });
        }

        function clearHistory() {
            if (confirm('Are you sure you want to clear your history?')) {
                localStorage.removeItem('taxi_history');
                document.getElementById('history-list').innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No history yet</div>';
            }
        }

        async function fetchMonitoringData() {
            try {
                const res = await fetch(`${API_BASE}/monitoring/drift`);
                if (!res.ok) return; // Silent fail or show placeholder

                const data = await res.json();

                // Update Model Info in card
                if (data.model_info) {
                    document.getElementById('model-info-name').innerText = data.model_info.name;
                    document.getElementById('model-info-version').innerText = data.model_info.version;
                }
                if (data.total_predictions !== undefined) {
                    document.getElementById('model-info-count').innerText = data.total_predictions;
                }

                renderCharts(data);
                updateDriftMetrics(data);

            } catch (e) {
                console.error("Monitoring fetch failed", e);
            }
        }

        function updateDriftMetrics(data) {
            if (!data.reference || !data.current) return;

            // Distance Drift
            if (data.reference.trip_distance && data.current.trip_distance) {
                const distRef = data.reference.trip_distance.mean;
                const distCurr = data.current.trip_distance.mean;
                const distDiff = ((distCurr - distRef) / distRef) * 100;

                document.getElementById('drift-distance-val').innerText = `${Math.abs(distDiff).toFixed(1)}%`;
                document.getElementById('drift-distance-status').innerText = distDiff > 0 ? 'Increase' : 'Decrease';
                document.getElementById('drift-distance-status').className = `text-sm font-medium ${Math.abs(distDiff) > 20 ? 'text-red-500' : 'text-green-500'}`;

                const distBarWidth = Math.min(Math.abs(distDiff) * 2, 100);
                document.getElementById('drift-distance-bar').style.width = `${distBarWidth}%`;
                document.getElementById('drift-distance-bar').className = `h-full transition-all duration-500 ${Math.abs(distDiff) > 20 ? 'bg-red-500' : 'bg-green-500'}`;
            }

            // Target/Fare Drift
            if (data.reference.fare_amount && data.current.fare_amount) {
                const fareRef = data.reference.fare_amount.mean;
                const fareCurr = data.current.fare_amount.mean;
                const fareDiff = ((fareCurr - fareRef) / fareRef) * 100;

                document.getElementById('drift-target-val').innerText = `${Math.abs(fareDiff).toFixed(1)}%`;
                document.getElementById('drift-target-status').innerText = fareDiff > 0 ? 'Increase' : 'Decrease';
                document.getElementById('drift-target-status').className = `text-sm font-medium ${Math.abs(fareDiff) > 20 ? 'text-red-500' : 'text-green-500'}`;

                const fareBarWidth = Math.min(Math.abs(fareDiff) * 2, 100);
                document.getElementById('drift-target-bar').style.width = `${fareBarWidth}%`;
                document.getElementById('drift-target-bar').className = `h-full transition-all duration-500 ${Math.abs(fareDiff) > 20 ? 'bg-red-500' : 'bg-purple-500'}`;
            }
        }

        function renderCharts(data) {
            const ctx1 = document.getElementById('chart-distance').getContext('2d');
            const ctx2 = document.getElementById('chart-target').getContext('2d');
            const ctxHistDist = document.getElementById('chart-distance-hist').getContext('2d');
            const ctxHistTarget = document.getElementById('chart-target-hist').getContext('2d');

            // Destroy existing charts
            Object.values(charts).forEach(c => c && c.destroy());

            // Bar chart: Comparing Means
            charts.dist = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Reference (Training)', 'Current (Production)'],
                    datasets: [{
                        label: 'Avg Trip Distance (miles)',
                        data: [data.reference.trip_distance?.mean || 0, data.current.trip_distance?.mean || 0],
                        backgroundColor: ['#3b82f6', '#10b981']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            charts.target = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['Reference', 'Current'],
                    datasets: [{
                        label: 'Avg Fare ($)',
                        data: [data.reference.fare_amount?.mean || 0, data.current.fare_amount?.mean || 0],
                        backgroundColor: ['#a855f7', '#22c55e']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            // Histogram: Distance Distribution (from reference data)
            if (data.reference.trip_distance?.hist && data.reference.trip_distance?.bin_edges) {
                const histData = data.reference.trip_distance.hist;
                const edges = data.reference.trip_distance.bin_edges;
                const labels = edges.slice(0, -1).map((e, i) => `${e.toFixed(1)}-${edges[i + 1].toFixed(1)}`);

                charts.distHist = new Chart(ctxHistDist, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency (Training Data)',
                            data: histData,
                            backgroundColor: '#818cf8',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true } },
                        scales: { x: { title: { display: true, text: 'Distance (miles)' } } }
                    }
                });
            }

            // Histogram: Fare/Target Distribution
            if (data.reference.fare_amount?.hist && data.reference.fare_amount?.bin_edges) {
                const histData = data.reference.fare_amount.hist;
                const edges = data.reference.fare_amount.bin_edges;
                const labels = edges.slice(0, -1).map((e, i) => `$${e.toFixed(0)}-$${edges[i + 1].toFixed(0)}`);

                charts.targetHist = new Chart(ctxHistTarget, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Frequency (Training Data)',
                            data: histData,
                            backgroundColor: '#a855f7',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: true } },
                        scales: { x: { title: { display: true, text: 'Fare Amount ($)' } } }
                    }
                });
            }
        }
    </script>
</body>

</html>